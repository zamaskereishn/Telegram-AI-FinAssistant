from openai import OpenAI
from config import config
from loguru import logger
from typing import List

# Configure OpenAI
client = OpenAI(api_key=config.OPENAI_API_KEY)


def summarize_chunk(chunk: str) -> str:
    """Summarize one chunk of scraped text."""
    prompt = (
        "–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –°–∂–∞—Ç–æ (3‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –≤—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã, "
        "–¥–∞—Ç—ã, —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞.\n\n"
        f"–¢–µ–∫—Å—Ç:\n{chunk}\n\n–û—Ç–≤–µ—Ç:"
    )
    try:
        response = client.chat.completions.create(
            model=config.OPENAI_MODEL,
            messages=[
                {"role": "system", "content": "–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –ö—Ä–∞—Ç–∫–æ —Å—É–º–º–∏—Ä—É–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã, –≤—ã–¥–µ–ª—è—è –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏ —á–∏—Å–ª–∞."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.4,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"OpenAI summarize_chunk error: {e}")
        return ""


def ask_openai(prompt: str) -> str:
    """Ask OpenAI about finance, banking, and economics only."""
    try:
        system_prompt = (
            "–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. "
            "–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏, —ç–∫–æ–Ω–æ–º–∏–∫–æ–π, –±–∞–Ω–∫–∞–º–∏, –≤–∞–ª—é—Ç–∞–º–∏ –∏ —Ä—ã–Ω–∫–∞–º–∏. "
            "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å —ç—Ç–∏–º–∏ —Ç–µ–º–∞–º–∏, –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏ –∏ –ø–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–º—ã."
        )
        response = client.chat.completions.create(
            model=config.OPENAI_MODEL,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"OpenAI ask_openai error: {e}")
        return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI API."


def aggregate_summaries(summaries: List[str], category: str = None) -> str:
    """Aggregate multiple summaries into one structured digest based on category."""

    if not summaries:
        return "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–∞."

    combined = "\n\n".join(summaries)

    # –°–ª–æ–≤–∞—Ä—å –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    category_prompts = {
        "macro": (
            "–ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–≤–æ–¥–æ–∫ —Å—Ñ–æ—Ä–º–∏—Ä—É–π —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –ú–ê–ö–†–û–≠–ö–û–ù–û–ú–ò–ö–ï. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n"
            "1. –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (3-5 –ø—É–Ω–∫—Ç–æ–≤)\n"
            "2. –ß–∏—Å–ª–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ —Ç—Ä–µ–Ω–¥—ã\n"
            "3. –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞\n\n"
            f"–°–≤–æ–¥–∫–∏:\n{combined}\n\n–î–∞–π–¥–∂–µ—Å—Ç:"
        ),
        "forex": (
            "–ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–≤–æ–¥–æ–∫ —Å—Ñ–æ—Ä–º–∏—Ä—É–π —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –í–ê–õ–Æ–¢–ê–ú –ò –ö–£–†–°–ê–ú. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n"
            "1. –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–∞–ª—é—Ç (USD, EUR, RUB)\n"
            "2. –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ä–æ—Å—Ç/–ø–∞–¥–µ–Ω–∏–µ)\n"
            "3. –§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è–Ω–∏—è –Ω–∞ –∫—É—Ä—Å—ã\n"
            "4. –ü—Ä–æ–≥–Ω–æ–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞–ª—é—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n\n"
            f"–°–≤–æ–¥–∫–∏:\n{combined}\n\n–î–∞–π–¥–∂–µ—Å—Ç:"
        ),
        "commodities": (
            "–ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–≤–æ–¥–æ–∫ —Å—Ñ–æ—Ä–º–∏—Ä—É–π —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –ù–ï–§–¢–ò –ò –°–´–†–¨–Æ. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n"
            "1. –¢–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –Ω–∞ –Ω–µ—Ñ—Ç—å (Brent, WTI)\n"
            "2. –î–∏–Ω–∞–º–∏–∫–∞ —Ä—ã–Ω–∫–∞ —Å—ã—Ä—å–µ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤\n"
            "3. –§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è–Ω–∏—è (–û–ü–ï–ö+, –≥–µ–æ–ø–æ–ª–∏—Ç–∏–∫–∞, —Å–ø—Ä–æ—Å)\n"
            "4. –í–ª–∏—è–Ω–∏–µ –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∫—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞\n"
            "5. –í—ã–≤–æ–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑\n\n"
            f"–°–≤–æ–¥–∫–∏:\n{combined}\n\n–î–∞–π–¥–∂–µ—Å—Ç:"
        ),
        "banks": (
            "–ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–≤–æ–¥–æ–∫ —Å—Ñ–æ—Ä–º–∏—Ä—É–π —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –ë–ê–ù–ö–û–í–°–ö–û–ú–£ –°–ï–ö–¢–û–†–£. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n"
            "1. –ö–ª—é—á–µ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –±–∞–Ω–∫–æ–≤\n"
            "2. –ù–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ —É—Å–ª—É–≥–∏\n"
            "3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–∏\n"
            "4. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫—Ä—É–ø–Ω—ã—Ö –±–∞–Ω–∫–æ–≤\n"
            "5. –í—ã–≤–æ–¥—ã –∏ —Ç—Ä–µ–Ω–¥—ã —Å–µ–∫—Ç–æ—Ä–∞\n\n"
            f"–°–≤–æ–¥–∫–∏:\n{combined}\n\n–î–∞–π–¥–∂–µ—Å—Ç:"
        ),
        "all": (
            "–ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–≤–æ–¥–æ–∫ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –ø–æ–ª–Ω—ã–π —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞–π–¥–∂–µ—Å—Ç. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n"
            "üìä –ú–ê–ö–†–û–≠–ö–û–ù–û–ú–ò–ö–ê (3-4 –ø—É–Ω–∫—Ç–∞)\n"
            "üí± –í–ê–õ–Æ–¢–´ (—Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –∏ –¥–∏–Ω–∞–º–∏–∫–∞)\n"
            "üõ¢Ô∏è –ù–ï–§–¢–¨ –ò –°–´–†–¨–Å (—Ü–µ–Ω—ã –∏ —Ç—Ä–µ–Ω–¥—ã)\n"
            "üè¶ –ë–ê–ù–ö–û–í–°–ö–ò–ô –°–ï–ö–¢–û–† (–∫–ª—é—á–µ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏)\n"
            "üìà –û–ë–©–ò–ï –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò\n\n"
            f"–°–≤–æ–¥–∫–∏:\n{combined}\n\n–î–∞–π–¥–∂–µ—Å—Ç:"
        )
    }

    # –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    prompt = category_prompts.get(category, category_prompts["all"])

    logger.info(f"Aggregating summaries for category: {category}")

    try:
        response = client.chat.completions.create(
            model=config.OPENAI_MODEL,
            messages=[
                {"role": "system", "content": "–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –û–±—ä–µ–¥–∏–Ω–∏ –∫—Ä–∞—Ç–∫–∏–µ —Å–≤–æ–¥–∫–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.5,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"OpenAI aggregate_summaries error: {e}")
        logger.exception(e)
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∞–π–¥–∂–µ—Å—Ç–∞: {str(e)}"